<%- include('./partials/visitantHeader')%>

    <br>
    <br>
    <div class="container">

        <h1 style="text-align: center">Consultar Inscri√ß√£o Estadual</h1>
        <h4 style="text-align: center">Pesquise gratuitamente por Inscri√ß√µes Estaduais do RS, SP e mais</h4>
        <br>

            <div class="row d-flex justify-content-center" >
                <div class="col-5">
                    <input type="text" class="form-control" name="cnpj" id="cnpj" placeholder="00.000.000/0000-00">
                </div>
                <div class="col-auto">
                    <button onclick="buscaIe()" class="btn btn-primary">Pesquisar</button>
                </div>
            </br>
            <br>
            <br>
            <div id="nomeBox"></div>
            <div id="resultadosBox" style="min-height: 150px"></div>
            </br>
            </br>
            <div class="text-center">
              <a href="https://loja.certidoc.com.br" target="_blank"><img class="mb-5" src="./img/certificado-digital-com-desconto.gif"></a>
            </div>
                <p style="text-align: center"><b>Consulta gratuita e sem limites aqui no site.</b></p>
            </div>
    </div>



</body>
<script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.mask/1.14.16/jquery.mask.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.11.8/dist/umd/popper.min.js" integrity="sha384-I7E8VVD/ismYTF4hNIPjVp/Zjvgyol6VFvRkX/vR+Vc4jQkC+hVqc2pM8ODewa9r" crossorigin="anonymous"></script>
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.min.js" integrity="sha384-BBtl+eGJRgqQAUMxJ7pMwbEyER4l1g+O15P+16Ep7Q9Q+zqX6gSbd85u4mG4QzX+" crossorigin="anonymous"></script>
<script scr="/js/bootstrap.min.js"></script>

<script>
  /*BUSCA IE*/

async function buscaIe(){

    //Criando e limpando o conte√∫do da caixa nome
    let caixaNome = document.getElementById('nomeBox');
  caixaNome.innerHTML = "";

  //Criando e limpando conte√∫do da DIV m√£e
  let caixaResultado = document.getElementById('resultadosBox');
  caixaResultado.innerHTML = ""


  let elementoNome = "";
  let elementoIe = "";
  let subDivi = "";

  try{

    let cnpj = (document.getElementById('cnpj').value).replace(/\D/g, "");

    let resultados = await axios.post('http://localhost:3333/cnpjfront',{cnpj: cnpj});
    console.log(resultados);

    if (resultados.data.rfbSituacaoCadastral != 2){
      throw new Error('CNPJ encontrado, por√©m empresa n√£o parece estar ATIVA na Receita Federal');
    }
    
    caixaResultado.setAttribute('class','square-box d-flex justify-content-center align-items-center');

    elementoNome = document.createElement('h4');
    elementoNome.setAttribute('style','text-align: center');
    elementoNome.innerHTML = `‚úÖ${resultados.data.rfbRazaoSocial}`;
    caixaNome.appendChild(elementoNome);

    if (resultados.data.inscricoes < 1) {
      elementoIe = document.createElement('div');
      elementoIe.setAttribute('style','text-align: center;font-size: 18px','class','col-2');
      elementoIe.innerHTML = `N√£o encontramos nenhuma <b>Inscri√ß√£o Estadual</b> Encontrada para esse CNPJ`;
      caixaResultado.appendChild(elementoIe);
    }

    for await(const resultado of resultados.data.inscricoes) {
          
          //Constru√≠ndo DIV filho que vai conter BANDEIRA + INSCRI√á√ÉO
          subDivi = document.createElement('div');
          subDivi.setAttribute('class','form-control resultados d-flex justify-content-center align-items-center');
          caixaResultado.appendChild(subDivi);

          //Construindo bandeira do estado
          elementoUf = document.createElement('div');
          //elementoUf.setAttribute('src',`./img/icons-states/${resultado.ieUf}.svg`);
          elementoUf.setAttribute('class','col 1 d-flex uf-flag', 'title', `${resultado.ieUf}`);
          elementoUf.innerHTML = `<img width="40px" src="./img/icons-states/${resultado.ieUf}.svg">`;
          subDivi.appendChild(elementoUf);

          //Constru√≠ndo inscri√ß√£o estadual
          elementoIe = document.createElement('div');
          elementoIe.setAttribute('style','text-align: center;font-size: 18px','class','col-2');
          elementoIe.innerHTML = `Inscri√ß√£o Estadual ${resultado.ieUf} encontrada: <b>${resultado.ieNumber}</b>`;
          subDivi.appendChild(elementoIe);
          console.log('sucesso');
    };

  }catch(err){
    let erroDescricao = '';

    if (err.response){
      console.log(err)
      if (err.response.status == 400){
      erroDescricao = 'CNPJ n√£o encontrado';
      } else {
        erroDescricao = err.response.data;
      }
    }

    if (err.request){

      if(err.request.status == 400){
      erroDescricao = 'CNPJ n√£o encontrado';
      } else{
      erroDescricao = err.request
      }
    }

    else{
      console.log(err)
      erroDescricao = err.message
    }

    elementoIe = document.createElement('p');
    elementoIe.setAttribute('style','text-align: center;font-size: 18px')
    elementoIe.innerHTML = `üö´ ${erroDescricao}`;
      
    caixaResultado.appendChild(elementoIe);
  }

}

//m√°scara CNPJ
$('#cnpj').mask('00.000.000/0000-00', {'translation': {0: {pattern: /[0-9]/}}});

</script>

<%- include('./partials/footer') %>



</html>